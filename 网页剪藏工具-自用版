// ==UserScript==
// @name         ç½‘é¡µå‰ªè—å·¥å…· Pro
// @namespace    http://tampermonkey.net/
// @version      4.3
// @description  å¢å¼ºç‰ˆç½‘é¡µå‰ªè—å·¥å…·ï¼Œæ”¯æŒè‡ªå®šä¹‰æ ‡ç­¾ã€é€‰æ‹©ç¬”è®°æœ¬å’Œç°ä»£åŒ–UIï¼Œå®Œå…¨å…¼å®¹PWA
// @author       You
// @match        *://*/*
// @grant        GM_xmlhttpRequest
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// @grant        GM_addStyle
// @downloadURL  https://raw.githubusercontent.com/byssssss/web-siyuan/refs/heads/main/%E7%BD%91%E9%A1%B5%E5%89%AA%E8%97%8F%E5%B7%A5%E5%85%B7-%E8%87%AA%E7%94%A8%E7%89%88
// @updateURL    https://raw.githubusercontent.com/byssssss/web-siyuan/refs/heads/main/%E7%BD%91%E9%A1%B5%E5%89%AA%E8%97%8F%E5%B7%A5%E5%85%B7-%E8%87%AA%E7%94%A8%E7%89%88
// ==/UserScript==

(function() {
    'use strict';

    // ===== 1. é…ç½®ç®¡ç†æ¨¡å— =====
    const Config = {
        keys: {
            backendUrl: 'web_clipper_backend_url',
            activeSites: 'web_clipper_active_sites',
            buttonPosition: 'web_clipper_button_position',
            // ===== æ–°å¢ï¼šå¢åŠ ä¸€ä¸ªkeyæ¥å­˜å‚¨ä¸Šæ¬¡é€‰æ‹©çš„ç¬”è®°æœ¬ID =====
            lastSelectedNotebookId: 'web_clipper_last_notebook_id'
        },

        getAll: function() {
            return {
                backendUrl: GM_getValue(this.keys.backendUrl, 'https://your-backend.com/api/clipping'),
                activeSites: GM_getValue(this.keys.activeSites, []),
                buttonPosition: GM_getValue(this.keys.buttonPosition, { top: '100px', right: '20px' }),
                // ===== æ–°å¢ï¼šè·å–ä¸Šæ¬¡é€‰æ‹©çš„ç¬”è®°æœ¬ID =====
                lastSelectedNotebookId: GM_getValue(this.keys.lastSelectedNotebookId, '')
            };
        },

        setAll: function(newConfig) {
            GM_setValue(this.keys.backendUrl, newConfig.backendUrl);
            GM_setValue(this.keys.activeSites, newConfig.activeSites);
            GM_setValue(this.keys.buttonPosition, newConfig.buttonPosition);
            // ===== æ–°å¢ï¼šè®¾ç½®ä¸Šæ¬¡é€‰æ‹©çš„ç¬”è®°æœ¬ID =====
            if (newConfig.lastSelectedNotebookId !== undefined) {
                GM_setValue(this.keys.lastSelectedNotebookId, newConfig.lastSelectedNotebookId);
            }
        },

        isComplete: function() {
            const config = this.getAll();
            return config.backendUrl && config.backendUrl !== 'https://your-backend.com/api/clipping';
        },

        showSettings: function() {
            const config = this.getAll();

            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('web-clipper-settings-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // æ·»åŠ æ ·å¼
            GM_addStyle(`
                #web-clipper-settings-modal {
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.3);
                    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                    z-index: 2147483647;
                    display: flex; justify-content: center; align-items: center;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                }
                #web-clipper-settings-content {
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                    padding: 32px; border-radius: 20px;
                    width: 90%; max-width: 500px;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    position: relative;
                }
                #web-clipper-settings-content h2 {
                    margin-top: 0; color: #1a1a1a; font-size: 20px;
                    display: flex; align-items: center; gap: 8px;
                }
                #web-clipper-settings-content label {
                    display: block; margin-top: 16px; margin-bottom: 6px;
                    font-weight: 500; color: #4a4a4a; font-size: 14px;
                }
                #web-clipper-settings-content input, #web-clipper-settings-content textarea {
                    width: 100%; padding: 12px; box-sizing: border-box;
                    border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px;
                    font-size: 14px; transition: all 0.3s;
                    background: rgba(255, 255, 255, 0.8);
                }
                #web-clipper-settings-content input:focus, #web-clipper-settings-content textarea:focus {
                    outline: none; border-color: rgba(76, 175, 80, 0.5);
                    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
                    background: rgba(255, 255, 255, 0.95);
                }
                #web-clipper-settings-buttons {
                    margin-top: 24px; text-align: right; display: flex; gap: 12px;
                    justify-content: flex-end;
                }
                #web-clipper-settings-buttons button {
                    padding: 12px 24px; border: none; border-radius: 12px;
                    cursor: pointer; font-size: 14px; font-weight: 500;
                    transition: all 0.3s; min-width: 80px;
                }
                #web-clipper-save-btn {
                    background: rgba(76, 175, 80, 0.9); color: white;
                }
                #web-clipper-save-btn:hover {
                    background: rgba(76, 175, 80, 1); transform: translateY(-1px);
                }
                #web-clipper-cancel-btn {
                    background: rgba(0, 0, 0, 0.1); color: #4a4a4a;
                }
                #web-clipper-cancel-btn:hover {
                    background: rgba(0, 0, 0, 0.15);
                }
            `);

            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'web-clipper-settings-modal';

            const content = document.createElement('div');
            content.id = 'web-clipper-settings-content';

            // åˆ›å»ºæ ‡é¢˜
            const title = document.createElement('h2');
            title.textContent = 'âš™ï¸ å‰ªè—å·¥å…·é…ç½®';
            content.appendChild(title);

            // åˆ›å»ºåç«¯åœ°å€è¾“å…¥
            const backendUrlLabel = document.createElement('label');
            backendUrlLabel.textContent = 'åç«¯æœåŠ¡åœ°å€';
            backendUrlLabel.setAttribute('for', 'backendUrl');
            content.appendChild(backendUrlLabel);

            const backendUrlInput = document.createElement('input');
            backendUrlInput.type = 'url';
            backendUrlInput.id = 'backendUrl';
            backendUrlInput.placeholder = 'https://your-domain.com/api/clipping';
            backendUrlInput.value = config.backendUrl;
            content.appendChild(backendUrlInput);

            // åˆ›å»ºæ¿€æ´»ç½‘ç«™åˆ—è¡¨
            const activeSitesLabel = document.createElement('label');
            activeSitesLabel.textContent = 'æ¿€æ´»ç½‘ç«™åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ªï¼Œç•™ç©ºè¡¨ç¤ºå…¨éƒ¨)';
            activeSitesLabel.setAttribute('for', 'activeSites');
            content.appendChild(activeSitesLabel);

            const activeSitesTextarea = document.createElement('textarea');
            activeSitesTextarea.id = 'activeSites';
            activeSitesTextarea.rows = '5';
            activeSitesTextarea.value = config.activeSites.join('\n');
            content.appendChild(activeSitesTextarea);

            // åˆ›å»ºæŒ‰é’®
            const buttons = document.createElement('div');
            buttons.id = 'web-clipper-settings-buttons';

            const cancelButton = document.createElement('button');
            cancelButton.id = 'web-clipper-cancel-btn';
            cancelButton.textContent = 'å–æ¶ˆ';
            cancelButton.addEventListener('click', () => {
                modal.remove();
            });
            buttons.appendChild(cancelButton);

            const saveButton = document.createElement('button');
            saveButton.id = 'web-clipper-save-btn';
            saveButton.textContent = 'ä¿å­˜';
            saveButton.addEventListener('click', () => {
                const newConfig = {
                    backendUrl: backendUrlInput.value.trim(),
                    activeSites: activeSitesTextarea.value.trim() ? activeSitesTextarea.value.trim().split('\n') : [],
                    buttonPosition: config.buttonPosition,
                    lastSelectedNotebookId: config.lastSelectedNotebookId // ä¿ç•™å·²æœ‰çš„ç¬”è®°æœ¬é€‰æ‹©
                };
                this.setAll(newConfig);
                modal.remove();
                Toast.show('é…ç½®å·²ä¿å­˜ï¼', 'success');
                setTimeout(() => window.location.reload(), 1000);
            });
            buttons.appendChild(saveButton);

            content.appendChild(buttons);
            modal.appendChild(content);

            // æ·»åŠ åˆ°body
            document.body.appendChild(modal);

            // ç»‘å®šèƒŒæ™¯ç‚¹å‡»äº‹ä»¶
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    };

    // ===== 2. Toast é€šçŸ¥ç³»ç»Ÿ (æ— æ”¹åŠ¨) =====
    const Toast = {
        show: function(message, type = 'info', duration = 3000) {
            // æ·»åŠ æ ·å¼
            if (!document.querySelector('#toast-styles')) {
                GM_addStyle(`
                    .toast {
                        position: fixed; top: 20px; right: 20px; z-index: 2147483647;
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                        border-radius: 12px; padding: 16px 20px;
                        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2); display: flex;
                        align-items: center; gap: 12px; min-width: 250px;
                        animation: slideInRight 0.3s ease; max-width: 90vw;
                    }
                    .toast-success { border-left: 4px solid rgba(76, 175, 80, 0.8); }
                    .toast-error { border-left: 4px solid rgba(244, 67, 54, 0.8); }
                    .toast-info { border-left: 4px solid rgba(33, 150, 243, 0.8); }
                    .toast-icon { font-size: 20px; }
                    .toast-message { flex: 1; font-size: 14px; color: #1a1a1a; }
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `);
            }

            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            // åˆ›å»ºå›¾æ ‡
            const icon = document.createElement('div');
            icon.className = 'toast-icon';
            icon.textContent = this.getIcon(type);

            // åˆ›å»ºæ¶ˆæ¯
            const messageEl = document.createElement('div');
            messageEl.className = 'toast-message';
            messageEl.textContent = message;

            // ç»„è£…
            toast.appendChild(icon);
            toast.appendChild(messageEl);

            // æ·»åŠ åˆ°body
            document.body.appendChild(toast);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        },

        getIcon: function(type) {
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };
            return icons[type] || icons.info;
        }
    };

    // ===== 3. å‰ªè—é¢æ¿æ¨¡å— =====
    const ClipperPanel = {
        isVisible: false,
        panel: null,

        show: function() {
            if (this.isVisible) return;
            this.isVisible = true;

            // ç§»é™¤å·²å­˜åœ¨çš„é¢æ¿
            const existingPanel = document.getElementById('clipper-panel');
            if (existingPanel) {
                existingPanel.remove();
            }

            // æ·»åŠ æ ·å¼
            if (!document.querySelector('#clipper-styles')) {
                GM_addStyle(`
                    #clipper-panel {
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0, 0, 0, 0.3);
                        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                        z-index: 2147483647;
                        display: flex; justify-content: center; align-items: center;
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                    }
                    .clipper-content {
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                        border-radius: 20px; width: 90%; max-width: 500px;
                        max-height: 80vh; overflow-y: auto;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                        position: relative;
                    }
                    .clipper-header {
                        padding: 24px; border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                        display: flex; justify-content: space-between; align-items: center;
                    }
                    .clipper-title { font-size: 18px; font-weight: 600; color: #1a1a1a; }
                    .clipper-close {
                        width: 32px; height: 32px; border-radius: 50%;
                        border: none; background: rgba(0, 0, 0, 0.1); cursor: pointer;
                        display: flex; align-items: center; justify-content: center;
                        transition: all 0.3s; font-size: 18px; color: #4a4a4a;
                    }
                    .clipper-close:hover {
                        background: rgba(0, 0, 0, 0.15);
                        transform: rotate(90deg);
                    }
                    .clipper-body { padding: 24px; }
                    .info-item {
                        margin-bottom: 20px;
                    }
                    .info-label {
                        font-size: 12px; color: #6a6a6a; margin-bottom: 8px;
                        font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;
                    }
                    .info-input, .info-select {
                        width: 100%; padding: 12px;
                        border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px;
                        font-size: 14px; transition: all 0.3s;
                        background: rgba(255, 255, 255, 0.8);
                        box-sizing: border-box;
                    }
                    /* ===== ä¿®æ”¹ï¼šä¸ºselectæ·»åŠ æ ·å¼ ===== */
                    .info-select {
                        -webkit-appearance: none;
                        -moz-appearance: none;
                        appearance: none;
                        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgba(0,0,0,0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                        background-repeat: no-repeat;
                        background-position: right 12px center;
                        background-size: 1em;
                        padding-right: 36px;
                    }
                    .info-input:focus, .info-select:focus {
                        outline: none; border-color: rgba(76, 175, 80, 0.5);
                        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
                        background: rgba(255, 255, 255, 0.95);
                    }
                    .info-input:hover, .info-select:hover {
                        border-color: rgba(0, 0, 0, 0.2);
                    }
                    .tags-hint {
                        font-size: 12px; color: #6a6a6a; margin-top: 8px;
                        display: flex; align-items: center; gap: 4px;
                    }
                    .clipper-footer {
                        padding: 24px; border-top: 1px solid rgba(0, 0, 0, 0.1);
                        display: flex; gap: 12px; justify-content: flex-end;
                    }
                    .clipper-btn {
                        padding: 12px 24px; border: none; border-radius: 12px;
                        cursor: pointer; font-size: 14px; font-weight: 500;
                        transition: all 0.3s; min-width: 100px;
                    }
                    .btn-clip {
                        background: rgba(76, 175, 80, 0.9); color: white;
                    }
                    .btn-clip:hover:not(:disabled) {
                        background: rgba(76, 175, 80, 1); transform: translateY(-1px);
                    }
                    .btn-clip:disabled {
                        background: rgba(0, 0, 0, 0.2); cursor: not-allowed;
                    }
                    .btn-cancel {
                        background: rgba(0, 0, 0, 0.1); color: #4a4a4a;
                    }
                    .btn-cancel:hover { background: rgba(0, 0, 0, 0.15); }
                    .loading-spinner {
                        display: inline-block; width: 16px; height: 16px;
                        border: 2px solid #ffffff; border-radius: 50%;
                        border-top-color: transparent; animation: spin 0.8s linear infinite;
                    }
                    @keyframes spin { to { transform: rotate(360deg); } }
                `);
            }

            // åˆ›å»ºé¢æ¿
            const panel = document.createElement('div');
            panel.id = 'clipper-panel';

            const content = document.createElement('div');
            content.className = 'clipper-content';

            // åˆ›å»ºå¤´éƒ¨
            const header = document.createElement('div');
            header.className = 'clipper-header';

            const title = document.createElement('div');
            title.className = 'clipper-title';
            title.textContent = 'âš¡ï¸ ç½‘é¡µå‰ªè—';

            const closeButton = document.createElement('button');
            closeButton.className = 'clipper-close';
            closeButton.textContent = 'Ã—';
            closeButton.addEventListener('click', () => {
                this.hide();
            });

            header.appendChild(title);
            header.appendChild(closeButton);

            // åˆ›å»ºä¸»ä½“
            const body = document.createElement('div');
            body.className = 'clipper-body';

            // ===== æ–°å¢ï¼šç¬”è®°æœ¬é€‰æ‹©ä¸‹æ‹‰æ¡† =====
            const notebookContainer = document.createElement('div');
            notebookContainer.className = 'info-item';

            const notebookLabel = document.createElement('div');
            notebookLabel.className = 'info-label';
            notebookLabel.textContent = 'ç¬”è®°æœ¬';

            const notebookSelect = document.createElement('select');
            notebookSelect.className = 'info-select';
            notebookSelect.id = 'notebook-select';
            notebookSelect.innerHTML = '<option value="">æ­£åœ¨åŠ è½½ç¬”è®°æœ¬åˆ—è¡¨...</option>';
            notebookSelect.disabled = true;

            notebookContainer.appendChild(notebookLabel);
            notebookContainer.appendChild(notebookSelect);

            // æ ‡é¢˜è¾“å…¥
            const titleContainer = document.createElement('div');
            titleContainer.className = 'info-item';

            const titleLabel = document.createElement('div');
            titleLabel.className = 'info-label';
            titleLabel.textContent = 'æ ‡é¢˜';

            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.className = 'info-input';
            titleInput.id = 'clip-title-input';
            titleInput.value = document.title;
            titleInput.placeholder = 'è¾“å…¥æ–‡ç« æ ‡é¢˜';

            titleContainer.appendChild(titleLabel);
            titleContainer.appendChild(titleInput);

            // URLè¾“å…¥
            const urlContainer = document.createElement('div');
            urlContainer.className = 'info-item';

            const urlLabel = document.createElement('div');
            urlLabel.className = 'info-label';
            urlLabel.textContent = 'é“¾æ¥';

            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.className = 'info-input';
            urlInput.id = 'clip-url-input';
            urlInput.value = window.location.href;
            urlInput.placeholder = 'è¾“å…¥æ–‡ç« é“¾æ¥';

            urlContainer.appendChild(urlLabel);
            urlContainer.appendChild(urlInput);

            // æ ‡ç­¾è¾“å…¥
            const tagsContainer = document.createElement('div');
            tagsContainer.className = 'info-item';

            const tagsLabel = document.createElement('div');
            tagsLabel.className = 'info-label';
            tagsLabel.textContent = 'è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰';

            const tagsInput = document.createElement('input');
            tagsInput.type = 'text';
            tagsInput.className = 'info-input';
            tagsInput.id = 'custom-tags-input';
            tagsInput.placeholder = 'è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·æˆ–ç©ºæ ¼åˆ†éš”';

            const tagsHint = document.createElement('div');
            tagsHint.className = 'tags-hint';
            tagsHint.textContent = 'ğŸ’¡ AIå°†æ ¹æ®æ‚¨çš„æ ‡ç­¾ç”Ÿæˆè¡¥å……æ ‡ç­¾ï¼Œé¿å…é‡å¤';

            tagsContainer.appendChild(tagsLabel);
            tagsContainer.appendChild(tagsInput);
            tagsContainer.appendChild(tagsHint);

            // ===== ä¿®æ”¹ï¼šè°ƒæ•´UIé¡ºåº =====
            body.appendChild(notebookContainer);
            body.appendChild(titleContainer);
            body.appendChild(urlContainer);
            body.appendChild(tagsContainer);

            // åˆ›å»ºåº•éƒ¨
            const footer = document.createElement('div');
            footer.className = 'clipper-footer';

            const cancelButton = document.createElement('button');
            cancelButton.className = 'clipper-btn btn-cancel';
            cancelButton.textContent = 'å–æ¶ˆ';
            cancelButton.addEventListener('click', () => {
                this.hide();
            });

            const clipButton = document.createElement('button');
            clipButton.className = 'clipper-btn btn-clip';

            const buttonText = document.createElement('span');
            buttonText.id = 'clip-button-text';
            buttonText.textContent = 'å¼€å§‹å‰ªè—';

            clipButton.appendChild(buttonText);
            clipButton.addEventListener('click', () => {
                WebClipper.doClip();
            });

            footer.appendChild(cancelButton);
            footer.appendChild(clipButton);

            // ç»„è£…é¢æ¿
            content.appendChild(header);
            content.appendChild(body);
            content.appendChild(footer);
            panel.appendChild(content);

            // æ·»åŠ åˆ°body
            document.body.appendChild(panel);

            this.panel = panel;

            // ç»‘å®šèƒŒæ™¯ç‚¹å‡»äº‹ä»¶
            panel.addEventListener('click', (e) => {
                if (e.target === panel) {
                    this.hide();
                }
            });

            // è‡ªåŠ¨èšç„¦æ ‡é¢˜è¾“å…¥æ¡†
            setTimeout(() => {
                titleInput.focus();
                titleInput.select();
            }, 300);

            // ===== æ–°å¢ï¼šé¢æ¿æ˜¾ç¤ºåï¼ŒåŠ è½½ç¬”è®°æœ¬åˆ—è¡¨ =====
            WebClipper.fetchNotebooks();
        },

        hide: function() {
            if (this.panel) {
                this.panel.remove();
                this.panel = null;
            }
            this.isVisible = false;
        },

        setLoading: function(loading) {
            const button = document.querySelector('.btn-clip');
            const buttonText = document.getElementById('clip-button-text');

            if (button && buttonText) {
                if (loading) {
                    button.disabled = true;
                    buttonText.textContent = '';
                    const spinner = document.createElement('span');
                    spinner.className = 'loading-spinner';
                    buttonText.parentNode.insertBefore(spinner, buttonText);
                    buttonText.textContent = ' å‰ªè—ä¸­...';
                } else {
                    button.disabled = false;
                    const spinner = button.querySelector('.loading-spinner');
                    if (spinner) spinner.remove();
                    buttonText.textContent = 'å¼€å§‹å‰ªè—';
                }
            }
        }
    };

    // ===== 4. æ ¸å¿ƒå‰ªè—æ¨¡å— =====
    const WebClipper = {
        config: {},
        button: null,
        dragThrottle: null,
        // ===== æ–°å¢ï¼šç”¨äºç¼“å­˜ç¬”è®°æœ¬åˆ—è¡¨ =====
        notebooks: [],

        init: function() {
            this.config = Config.getAll();

            if (!Config.isComplete()) {
                console.warn('è„šæœ¬é…ç½®ä¸å®Œæ•´ï¼Œè¯·åœ¨èœå•ä¸­æ‰“å¼€è®¾ç½®è¿›è¡Œé…ç½®ã€‚');
                return;
            }

            if (this.config.activeSites.length > 0) {
                const currentHostname = window.location.hostname;
                const isAllowed = this.config.activeSites.some(site => {
                    const regex = new RegExp('^' + site.replace(/\./g, '\\.').replace(/\*/g, '.*') + '$');
                    return regex.test(currentHostname);
                });
                if (!isAllowed) {
                    return;
                }
            }

            console.log(`Web Clipper: å¯åŠ¨`);

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => this.createFloatingButton());
            } else {
                setTimeout(() => this.createFloatingButton(), 500);
            }
        },

        fetchWithGM: function(details) {
            return new Promise((resolve, reject) => {
                details.onload = (res) => {
                    if (res.status >= 200 && res.status < 300) {
                        resolve(res);
                    } else {
                        reject(new Error(`è¯·æ±‚å¤±è´¥: ${res.status} ${res.statusText}`));
                    }
                };
                details.onerror = (err) => reject(err);
                GM_xmlhttpRequest(details);
            });
        },

        // ===== æ–°å¢ï¼šè·å–ç¬”è®°æœ¬åˆ—è¡¨çš„å‡½æ•° =====
        fetchNotebooks: async function() {
            const selectElement = document.getElementById('notebook-select');
            if (!selectElement) return;

            try {
                const response = await this.fetchWithGM({
                    method: 'GET',
                    url: `${this.config.backendUrl.replace('/api/clipping', '')}/api/notebooks`
                });
                const result = JSON.parse(response.responseText);

                if (result.success && result.notebooks) {
                    this.notebooks = result.notebooks;
                    selectElement.innerHTML = '';
                    this.notebooks.forEach(nb => {
                        const option = document.createElement('option');
                        option.value = nb.id;
                        option.textContent = nb.name;
                        selectElement.appendChild(option);
                    });
                    selectElement.disabled = false;

                    // è®¾ç½®ä¸Šæ¬¡é€‰æ‹©çš„ç¬”è®°æœ¬
                    if (this.config.lastSelectedNotebookId) {
                        selectElement.value = this.config.lastSelectedNotebookId;
                    }
                } else {
                    throw new Error(result.error || 'è·å–ç¬”è®°æœ¬åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ç¬”è®°æœ¬åˆ—è¡¨å¤±è´¥:', error);
                selectElement.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                Toast.show('åŠ è½½ç¬”è®°æœ¬åˆ—è¡¨å¤±è´¥', 'error');
            }
        },

        doClip: async function() {
            const titleInput = document.getElementById('clip-title-input');
            const urlInput = document.getElementById('clip-url-input');
            const tagsInput = document.getElementById('custom-tags-input');
            // ===== æ–°å¢ï¼šè·å–é€‰æ‹©çš„ç¬”è®°æœ¬ID =====
            const notebookSelect = document.getElementById('notebook-select');

            const title = titleInput ? titleInput.value.trim() : document.title;
            const url = urlInput ? urlInput.value.trim() : window.location.href;
            const customTags = tagsInput ?
                tagsInput.value.split(/[,ï¼Œ\s]+/).map(tag => tag.trim()).filter(tag => tag) : [];
            // ===== æ–°å¢ï¼šè·å–notebookId =====
            const notebookId = notebookSelect ? notebookSelect.value : '';

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!title) {
                Toast.show('è¯·è¾“å…¥æ ‡é¢˜', 'error');
                return;
            }
            if (!url) {
                Toast.show('è¯·è¾“å…¥é“¾æ¥', 'error');
                return;
            }
            // ===== æ–°å¢ï¼šéªŒè¯æ˜¯å¦é€‰æ‹©äº†ç¬”è®°æœ¬ =====
            if (!notebookId) {
                Toast.show('è¯·é€‰æ‹©ä¸€ä¸ªç¬”è®°æœ¬', 'error');
                return;
            }

            ClipperPanel.setLoading(true);

            try {
                const data = {
                    title: title,
                    url: url,
                    html: document.documentElement.outerHTML,
                    customTags: customTags,
                    // ===== æ–°å¢ï¼šå°†notebookIdåŠ å…¥æ•°æ®ä½“ =====
                    notebookId: notebookId
                };

                const response = await this.fetchWithGM({
                    method: 'POST',
                    url: this.config.backendUrl,
                    headers: { 'Content-Type': 'application/json' },
                    data: JSON.stringify(data)
                });

                const result = JSON.parse(response.responseText);

                if (result.success) {
                    // ===== æ–°å¢ï¼šä¿å­˜ç”¨æˆ·é€‰æ‹©çš„ç¬”è®°æœ¬ID =====
                    const currentConfig = Config.getAll();
                    currentConfig.lastSelectedNotebookId = notebookId;
                    Config.setAll(currentConfig);

                    ClipperPanel.hide();
                    Toast.show(`å‰ªè—æˆåŠŸï¼ç”Ÿæˆæ ‡ç­¾ï¼š${result.tags}`, 'success');
                    if (this.button) {
                        const originalText = this.button.textContent;
                        this.button.textContent = 'âœ…';
                        setTimeout(() => { this.button.textContent = originalText; }, 2000);
                    }
                } else {
                    throw new Error(result.error || 'å‰ªè—æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error('å‰ªè—å¤±è´¥:', error);
                Toast.show(`å‰ªè—å¤±è´¥: ${error.message}`, 'error');
            } finally {
                ClipperPanel.setLoading(false);
            }
        },

        makeDraggable: function(element) {
            let isDragging = false;
            let startX, startY, initialTop, initialRight;

            function handleStart(e) {
                isDragging = true;
                startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                const rect = element.getBoundingClientRect();
                initialTop = rect.top;
                initialRight = window.innerWidth - rect.right;
                element.style.cursor = 'grabbing';
                element.style.transition = 'none';
            }

            function handleMove(e) {
                if (!isDragging) return;

                // ä½¿ç”¨èŠ‚æµä¼˜åŒ–æ€§èƒ½
                if (WebClipper.dragThrottle) return;
                WebClipper.dragThrottle = requestAnimationFrame(() => {
                    WebClipper.dragThrottle = null;

                    e.preventDefault();
                    const currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    const currentY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                    const deltaY = currentY - startY;
                    const deltaX = currentX - startX;
                    const newTop = initialTop + deltaY;
                    const newRight = initialRight - deltaX;

                    element.style.top = `${newTop}px`;
                    element.style.right = `${newRight}px`;
                    element.style.left = 'auto';
                    element.style.bottom = 'auto';
                });
            }

            function handleEnd() {
                if (!isDragging) return;
                isDragging = false;
                element.style.cursor = 'move';
                element.style.transition = '';

                if (WebClipper.dragThrottle) {
                    cancelAnimationFrame(WebClipper.dragThrottle);
                    WebClipper.dragThrottle = null;
                }

                const style = window.getComputedStyle(element);
                const newPosition = { top: style.top, right: style.right };
                WebClipper.config.buttonPosition = newPosition;
                Config.setAll(WebClipper.config);
            }

            element.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);
            element.addEventListener('touchstart', handleStart, { passive: false });
            document.addEventListener('touchmove', handleMove, { passive: false });
            element.addEventListener('touchend', handleEnd);
        },

        createFloatingButton: function() {
            if (document.getElementById('web-clipper-btn')) return;

            // æ·»åŠ æ ·å¼ - ä¿®å¤æŒ‰é’®å¯è§æ€§é—®é¢˜
            GM_addStyle(`
                #web-clipper-btn {
                    position: fixed; z-index: 2147483646; cursor: move; user-select: none;
                    font-size: 24px; top: ${this.config.buttonPosition.top}; right: ${this.config.buttonPosition.right};
                    width: 48px; height: 48px; border-radius: 50%;
                    background: linear-gradient(135deg, rgba(76, 175, 80, 0.9), rgba(69, 160, 73, 0.9));
                    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                    color: white; display: flex; align-items: center; justify-content: center;
                    box-shadow: 0 8px 32px -8px rgba(76, 175, 80, 0.4);
                    transition: all 0.2s ease;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }
                #web-clipper-btn:hover {
                    transform: scale(1.05);
                    box-shadow: 0 12px 40px -8px rgba(76, 175, 80, 0.5);
                    background: linear-gradient(135deg, rgba(76, 175, 80, 1), rgba(69, 160, 73, 1));
                }
                #web-clipper-btn:active {
                    transform: scale(0.95);
                }
                @media (max-width: 768px) {
                    #web-clipper-btn {
                        width: 44px; height: 44px; font-size: 20px;
                    }
                }
            `);

            this.button = document.createElement('div');
            this.button.id = 'web-clipper-btn';
            this.button.title = 'ç‚¹å‡»å‰ªè—ï¼ŒåŒå‡»æ‰“å¼€è®¾ç½®';
            this.button.textContent = 'âš¡ï¸';
            this.button.style.cssText = `
                position: fixed; z-index: 2147483646; cursor: move; user-select: none;
                font-size: 24px; top: ${this.config.buttonPosition.top}; right: ${this.config.buttonPosition.right};
            `;

            document.body.appendChild(this.button);
            this.makeDraggable(this.button);

            this.button.addEventListener('click', (e) => {
                if (e.detail === 1) {
                    setTimeout(() => ClipperPanel.show(), 200);
                }
            });

            this.button.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                Config.showSettings();
            });

            console.log('å‰ªè—æŒ‰é’®å·²åˆ›å»º');
        }
    };

    // ===== 5. åˆå§‹åŒ–å’Œèœå•æ³¨å†Œ (æ— æ”¹åŠ¨) =====
    GM_registerMenuCommand('âš™ï¸ å‰ªè—å·¥å…·è®¾ç½®', () => { Config.showSettings(); });

    console.log('Web Clipper Pro è„šæœ¬å·²åŠ è½½');

    if (!Config.isComplete()) {
        console.warn('æ£€æµ‹åˆ°é…ç½®ä¸å®Œæ•´ï¼Œå·²å¼¹å‡ºè®¾ç½®çª—å£ã€‚');
        Config.showSettings();
    }

    WebClipper.init();

})();
